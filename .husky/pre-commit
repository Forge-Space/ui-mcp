#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit validations (matching CI/CD pipeline)...\n"

# 1. Lint and format (via lint-staged for changed files only)
echo "ğŸ“ Running lint and format checks on staged files..."
npx lint-staged || {
  echo "âŒ Lint/format check failed. Fix the issues above."
  exit 1
}

# 2. Type checking (full project)
echo "\nğŸ” Running TypeScript type check..."
npx tsc --noEmit || {
  echo "âŒ Type check failed. Fix the type errors above."
  exit 1
}

# 3. Run tests
echo "\nğŸ§ª Running tests..."
npm test -- --bail --passWithNoTests || {
  echo "âŒ Tests failed. Fix the failing tests above."
  exit 1
}

# 4. Build verification
echo "\nï¿½ Verifying build..."
npm run build || {
  echo "âŒ Build failed. Fix the build errors above."
  exit 1
}

# Verify build output exists
if [ ! -f dist/index.js ]; then
  echo "âŒ Build output missing: dist/index.js not found."
  exit 1
fi

echo "\nâœ… All pre-commit validations passed!"
echo "ğŸ“¦ Ready to commit and push.\n"
