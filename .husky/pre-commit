#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit validations (matching CI/CD pipeline)...\n"

FAILED=0

# 1. Lint and format (via lint-staged for changed files only)
echo "ğŸ“ Running lint and format checks on staged files..."
if ! npx lint-staged; then
  echo "âŒ Lint/format check failed."
  FAILED=1
else
  echo "âœ… Lint/format check passed."
fi

# 2. Type checking (full project)
echo "\nğŸ” Running TypeScript type check..."
if ! npx tsc --noEmit; then
  echo "âŒ Type check failed."
  FAILED=1
else
  echo "âœ… Type check passed."
fi

# 3. Run tests
echo "\nğŸ§ª Running tests..."
if ! npm test -- --bail --passWithNoTests; then
  echo "âŒ Tests failed."
  FAILED=1
else
  echo "âœ… Tests passed."
fi

# 4. Build verification
echo "\nğŸ“¦ Verifying build..."
if ! npm run build; then
  echo "âŒ Build failed."
  FAILED=1
else
  echo "âœ… Build passed."
  # Verify build output exists
  if [ ! -f dist/index.js ]; then
    echo "âŒ Build output missing: dist/index.js not found."
    FAILED=1
  fi
fi

# Summary
echo "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
  echo "âœ… All pre-commit validations passed!"
  echo "ğŸ“¦ Ready to commit and push."
else
  echo "âŒ Some validations failed. Please fix the issues above."
  echo "ğŸ’¡ All validation steps were run to show all issues at once."
  exit 1
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
