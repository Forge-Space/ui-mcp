name: "Setup siza-gen"
description: "Clone and build @forgespace/siza-gen as sibling directory for file: protocol resolution"

runs:
  using: "composite"
  steps:
    - name: Clone and build siza-gen
      shell: bash
      run: |
        if [ ! -d "../siza-gen" ]; then
          git clone --depth 1 https://github.com/Forge-Space/siza-gen.git ../siza-gen
          cd ../siza-gen
          INSTALLED=false
          for i in 1 2 3; do
            if npm install --legacy-peer-deps --fetch-retries=5; then
              INSTALLED=true
              break
            fi
            echo "npm install attempt $i failed, retrying..."
            [ $i -lt 3 ] && sleep 5
          done
          if [ "$INSTALLED" = false ]; then
            echo "::error::Failed to install siza-gen dependencies after 3 attempts"
            exit 1
          fi
          npm run build
        fi
